<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />

    <link rel="stylesheet" href="styles.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Link to the external CSS stylesheet for page styling -->
    <style>
        input[type=checkbox] {
            accent-color: #808d67;
            /* Custom color for checkboxes */
        }
    </style>

</head>

<body>
    <% if (typeof successMessage !=="undefined" ) { %>
        <div class="alert alert-success" role="alert">
            <%= successMessage %>
        </div>
        <% } %>

            <div class="forms">
                <div class="div">
                    <div class="overlap">
                        <div class="text-wrapper">Environmental Compliance Management System</div>
                        <img class="enveng-logo" src="img/enveng-logo-1.svg" />
                        <!-- Logo image for the compliance system -->
                        <div class="overlap-group">
                            <div class="avatar-block">
                                <a class="btn btn-warning" href="/logout">  Logout</a>
                                <div class="avatar">
                                    <img src="img/shape-1.png"
                                        style="height: 90%;width: auto;border-radius: 50%;margin: 4% auto;" alt="">
                                    <!-- User avatar image -->
                                </div>
                                <div class="info">
                                    <div class="text-wrapper-2">Title</div>
                                    <div class="text-wrapper-3">Description</div>
                                    <!-- Placeholder for title and description -->
                                </div>
                            </div>
                            <div class="settings">
                                <img class="enveng-logo"
                                    style="height: 90%;width: auto;border-radius: 50%;margin: 4% auto;"
                                    src="img/settings-1.svg" />
                                <!-- Settings icon -->
                            </div>
                            <img class="help-circle" src="img/help-circle.svg" />
                            <!-- Help icon -->
                        </div>
                    </div>
                    <div class="navigation-bar-wrapper">
                        <div class="navigation-bar">
                            <div class="overlap-group-2">
                                <div class="div-wrapper">
                                    <div class="text-wrapper-4"><a href="/form">Obligations</a></div>
                                    <!-- Navigation link to Forms page -->
                                </div>
                                <div class="text-wrapper-5"><a href="/responsible">Responsible</a></div>
                                <!-- Navigation link to Responsible page -->
                                <div class="text-wrapper-6"><a href="/">Dashboard</a></div>
                                <!-- Navigation link to Dashboard page -->
                            </div>
                        </div>
                    </div>
                    </header>
                    <div class="body" style="width: 100%;">
                        <div class="rectangle" style="width: 40%;"></div>
                        <!-- Decorative rectangle -->
                        <div class="form-list-icons">
                            <div class="rectangle-2"></div>
                            <!-- Placeholder rectangle for icons -->
                            <div class="settings-icon">
                                <a href="#" id="update-selected">
                                    <div class="settings-2"><img class="img"
                                            style="height: 90%;width: auto;;margin:  auto;" src="img/settings-1.svg" />
                                    </div>
                                </a>
                                <!-- Settings icon -->
                            </div>
                            <div class="img-wrapper"><img class="search" src="img/search-2.svg" /></div>
                            <!-- Search icon -->
                            <div class="img-wrapper"><a href="/newform"> <img class="img" src="img/plus-2.svg" /> </a>
                            </div>
                            <!-- Plus icon to create a new form -->
                            <div class="img-wrapper"><a href="#" id="delete-selected"> <img class="img"
                                        src="img/trash-2-2.svg" />
                                </a>
                            </div>
                            <!-- Trash icon for deleting items -->
                            <div class="img-wrapper"><img class="img" src="img/refresh-cw-3.svg" /></div>
                            <!-- Refresh icon -->
                        </div>
                        <div class="navbar">

                            <div class="checkboxes">
                                <div class="state-layer">
                                    <div class="container"></div>
                                    <!-- Placeholder for checkboxes -->
                                </div>
                            </div>

                            <!-- Table headers for displaying obligations -->
                            <div class="text-wrapper-7">Primary Environmental Mechanism</div>
                            <img class="chevron-down" src="img/chevron-down-5.svg" />
                            <div class="rectangle-3"></div>
                            <div class="text-wrapper-7">Obligation Number</div>
                            <img class="chevron-down" src="img/chevron-down-5.svg" />
                            <div class="rectangle-3"></div>
                            <div class="text-wrapper-7">Due Date</div>
                            <img class="chevron-down" src="img/chevron-down-5.svg" />
                            <div class="rectangle-3"></div>
                            <div class="text-wrapper-7">Status</div>
                            <img class="chevron-down" src="img/chevron-down-5.svg" />
                            <div class="rectangle-3"></div>
                            <div class="text-wrapper-7">Procedure</div>
                            <img class="chevron-down" src="img/chevron-down-5.svg" />
                            <div class="rectangle-3"></div>
                            <div class="text-wrapper-7">Responsibility</div>
                            <img class="chevron-down" src="img/chevron-down-5.svg" />
                            <div class="rectangle-3"></div>
                            <div class="text-wrapper-7">Environmental&nbsp;&nbsp;Aspect</div>
                            <img class="chevron-down" src="img/chevron-down-5.svg" />
                            <div class="rectangle-4"></div>
                        </div>
                        <!-- Filter buttons -->
                        <div class="filter-buttons">
                            <button id="overdue-btn">Overdue</button>
                            <button id="14-day-lookahead-btn">14-Day Look Ahead</button>
                            <button id="reset-filter-btn">Reset Filter</button>
                        </div>
                        <!-- <% obligations.forEach(obligation=> { %>
              <div class="navbar-2 obligation-row" data-duedate="<%= obligation.due_date %>">
                <div class="checkboxes">
                  <div class="state-layer">
                    <input type="checkbox" class="container-2" name="obligationsToDelete" value="<%= obligation.id %>">
                  </div>
                </div>
                <div class="text-wrapper-8">
                  <%= obligation.primary_environmental_mechanism %>
                </div>
                <div class="obligation-number">
                  <%= obligation.obligation_number %>
                </div>
                <div class="due-date">
                  <%= obligation.due_date %>
                </div>
                <div class="text-wrapper-9">
                  <%= obligation.status %>
                </div>
                <div class="text-wrapper-10">
                  <%= obligation.responsibility %>
                </div>
                <div class="responsibility">
                  <%= obligation.environmental_aspect %>
                </div>
              </div>
              <% }) %> -->

                        <% obligations.forEach(obligation=> { %>
                            <div class="navbar-2 obligation-row"
                                data-duedate="<%= new Date(obligation.due_date).toISOString() %>">

                                <!-- <div class="navbar-2 obligation-row"  data-duedate="<%= obligation.due_date %>"> -->
                                <div class="checkboxes">
                                    <div class="state-layer">
                                        <input type="checkbox" class="container-2" name="obligationsToDelete"
                                            value="<%= obligation.id %>">
                                    </div>
                                </div>
                                <div class="text-wrapper-8">
                                    <%= obligation.primary_environmental_mechanism %>
                                </div>
                                <div class="obligation-number">
                                    <%= obligation.obligation_number %>
                                </div>
                                <div class="due-date">
                                    <%= obligation.due_date %>
                                </div>
                                <div class="text-wrapper-9">
                                    <%= obligation.status %>
                                </div>
                                <div class="text-wrapper-10">
                                    <%= obligation.responsibility %>
                                </div>
                                <div class="responsibility">
                                    <%= obligation.environmental_aspect %>
                                </div>
                                <br>
                                <% }) %>
                            </div>

                    </div>
                </div>
            </div>
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script>

                // Filter for overdue obligations
                $('#overdue-btn').on('click', function () {
                    let today = new Date('');
                    $('.obligation-row').each(function () {
                        let dueDate = new Date($(this).data('duedate'));
                        console.log(dueDate);
                        // console.log(today);

                        if (dueDate <= today) {
                            $(this).show();  // Show overdue obligations
                        } else {
                            $(this).hide();  // Hide obligations that are not overdue
                        }
                    });
                });

                // Filter for 14-day look ahead
                $('#14-day-lookahead-btn').on('click', function () {
                    let today = new Date();
                    let fourteenDaysAhead = new Date(today);
                    fourteenDaysAhead.setDate(today.getDate() + 14);

                    $('.obligation-row').each(function () {
                        let dueDate = new Date($(this).data('duedate'));
                        if (dueDate >= today && dueDate <= fourteenDaysAhead) {
                            $(this).show();  // Show obligations within 14 days
                        } else {
                            $(this).hide();  // Hide obligations outside of 14-day look ahead
                        }
                    });
                });

                // Reset filters
                $('#reset-filter-btn').on('click', function () {
                    $('.obligation-row').show();  // Show all obligations
                });


                $(document).ready(function () {
                    $('#myTable').DataTable();
                });

                // Function to get the checked obligation IDs
                function getSelectedObligations() {
                    let selected = [];
                    $('input[name="obligationsToDelete"]:checked').each(function () {
                        selected.push($(this).val());
                    });
                    return selected;
                }

                // Handle update action
                $('#update-selected').on('click', function (e) {
                    e.preventDefault();
                    const selectedObligations = getSelectedObligations();

                    if (selectedObligations.length === 1) {
                        // Redirect to the update form for the selected obligation
                        window.location.href = `/updateform/${selectedObligations[0]}`;
                    } else {
                        alert('Please select exactly one obligation to update.');
                    }
                });

                // Handle delete action
                $('#delete-selected').on('click', function (e) {
                    e.preventDefault();
                    const selectedObligations = getSelectedObligations();

                    if (selectedObligations.length === 0) {
                        alert('Please select at least one obligation to delete.');
                        return;
                    }

                    if (confirm('Are you sure you want to delete the selected obligations?')) {
                        $.ajax({
                            url: '/deleteform',
                            method: 'POST',
                            data: { obligationIds: selectedObligations },
                            success: function (response) {
                                // Refresh the page or handle success
                                alert('Obligations deleted successfully');
                                location.reload();  // Reload the page to see updated list
                            },
                            error: function (err) {
                                alert('Error deleting obligations');
                            }
                        });
                    }
                });
            </script>

</body>

</html>